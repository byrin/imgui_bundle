name: Build imgui_bundle for Windows x64 (VS2019)

on:
  push:
    branches: [ main ]
    paths:
      - 'external/imgui_bundle/**'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2019
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 16 2019" -A x64 -DCMAKE_CXX_STANDARD=17

    - name: Build
      run: |
        cd build
        cmake --build . --config Release

    - name: Package
      run: |
        cd build
        mkdir imgui_bundle
        # 复制必要的文件（根据实际需要调整）
        xcopy ..\external\imgui_bundle\imgui_bundle imgui_bundle\imgui_bundle\ /E /I /H /Y
        # 如果有其他需要的文件，可以继续添加
        
        # 创建压缩包
        7z a imgui_bundle-windows-vs2019-x64.zip imgui_bundle

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}-win-x64
        release_name: Release Windows x64 VS2019 v${{ github.run_number }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/imgui_bundle-windows-vs2019-x64.zip
        asset_name: imgui_bundle-windows-vs2019-x64.zip
        asset_content_type: application/zip
